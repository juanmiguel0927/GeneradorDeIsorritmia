<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Isorritmia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la librería Tone.js directamente en el encabezado para evitar errores de carga asíncrona -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .note-card {
            transition: all 0.2s ease-in-out;
            transform: scale(1);
        }
        .note-card.active {
            background-color: #bbf7d0;
            border-color: #22c55e;
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-4xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Generador de Isorritmia</h1>
        <!-- Créditos del autor actualizados -->
        <p class="text-center text-sm text-gray-500 mb-8">Diseñado por Juan Miguel Rios Redondo</p>

        <!-- Nueva sección de explicación de conceptos -->
        <div class="mb-8 p-6 bg-gray-50 rounded-xl border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Conceptos de Isorritmia</h2>
            <div class="space-y-4 text-gray-600">
                <p>La <strong>Isorritmia</strong> es una técnica de composición musical que se basa en la repetición de patrones rítmicos y melódicos de diferente duración. Fue muy popular en la música medieval. Los dos elementos principales son el <strong>Color</strong> y la <strong>Talea</strong>.</p>
                
                <div>
                    <h3 class="text-lg font-semibold text-gray-700">Talea (Ritmo)</h3>
                    <p>La <strong>Talea</strong> es el patrón rítmico que se repite. En esta aplicación, puedes definir la longitud del patrón de ritmos (por ejemplo, una serie de negras y corcheas). La Talea es el esqueleto rítmico de la composición.</p>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold text-gray-700">Color (Melodía)</h3>
                    <p>El <strong>Color</strong> es el patrón melódico, es decir, la secuencia de notas que se repite. Un rasgo importante es que las notas del Color son únicas y no se repiten entre sí. En esta aplicación, la longitud del Color se puede ajustar, pero está limitada a 13 para garantizar que cada nota sea diferente.</p>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold text-gray-700">Relación entre Color y Talea</h3>
                    <p>La esencia de la isorritmia radica en que el <strong>Color</strong> y la <strong>Talea</strong> tienen longitudes diferentes. Esto hace que sus puntos de inicio y final no coincidan, creando una composición en la que las notas y los ritmos se combinan de forma inesperada a lo largo del tiempo. La composición completa se crea al superponer y repetir ambos patrones.</p>
                </div>
            </div>
        </div>

        <!-- Controles para la longitud de Color y Talea y la repetición -->
        <div class="mb-6 flex flex-col sm:flex-row gap-4 justify-between">
            <div class="flex-1">
                <label for="color-length-input" class="block text-sm font-medium text-gray-700">Longitud de Color (Notas)</label>
                <input type="number" id="color-length-input" value="8" min="4" max="13"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500 sm:text-sm p-2">
            </div>
            <div class="flex-1">
                <label for="talea-length-input" class="block text-sm font-medium text-gray-700">Longitud de Talea (Ritmos)</label>
                <input type="number" id="talea-length-input" value="4" min="2" max="10"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
            </div>
            <div class="flex-1">
                <label for="repetition-count-input" class="block text-sm font-medium text-gray-700">Repeticiones</label>
                <input type="number" id="repetition-count-input" value="2" min="1" max="5"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-purple-500 focus:ring-purple-500 sm:text-sm p-2">
            </div>
        </div>

        <div class="space-y-6">
            <!-- Visualización del Color (Melodía) -->
            <div>
                <h2 class="text-xl font-semibold text-gray-700 mb-2 flex items-center">
                    <span class="inline-block w-3 h-3 bg-red-400 rounded-full mr-2"></span>
                    Color (Melodía)
                </h2>
                <div id="color-display" class="flex flex-wrap gap-2 p-4 bg-gray-50 rounded-lg border border-red-300">
                </div>
            </div>

            <!-- Visualización de la Talea (Ritmo) -->
            <div>
                <h2 class="text-xl font-semibold text-gray-700 mb-2 flex items-center">
                    <span class="inline-block w-3 h-3 bg-blue-400 rounded-full mr-2"></span>
                    Talea (Ritmo)
                </h2>
                <div id="talea-display" class="flex flex-wrap items-end justify-start gap-2 p-4 bg-gray-50 rounded-lg border border-blue-300">
                </div>
            </div>
            
            <!-- Visualización de la Secuencia Completa -->
            <div>
                <h2 class="text-xl font-semibold text-gray-700 mb-2 flex items-center">
                    <span class="inline-block w-3 h-3 bg-purple-400 rounded-full mr-2"></span>
                    Secuencia Completa
                </h2>
                <div id="sequence-display" class="flex flex-wrap gap-2 p-4 bg-gray-50 rounded-lg border border-purple-300">
                </div>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 mt-8">
            <button id="generate-button"
                class="flex-1 bg-green-500 text-white font-bold py-3 px-6 rounded-xl shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2 transition ease-in-out duration-150">
                Generar
            </button>
            <button id="play-button" disabled
                class="flex-1 bg-blue-500 text-white font-bold py-3 px-6 rounded-xl shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 transition ease-in-out duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                Reproducir
            </button>
        </div>

        <div id="message-box" class="mt-6 text-center text-sm text-gray-500 min-h-[20px]">
        </div>
    </div>
    
    <script>
        // Función principal que inicializa la aplicación.
        function initApp() {
            // Referencias a los elementos del DOM.
            const generateButton = document.getElementById('generate-button');
            const playButton = document.getElementById('play-button');
            const colorDisplay = document.getElementById('color-display');
            const taleaDisplay = document.getElementById('talea-display');
            const sequenceDisplay = document.getElementById('sequence-display');
            const messageBox = document.getElementById('message-box');
            
            // Inputs para controlar la longitud de Color, Talea y repeticiones
            const colorLengthInput = document.getElementById('color-length-input');
            const taleaLengthInput = document.getElementById('talea-length-input');
            const repetitionCountInput = document.getElementById('repetition-count-input');
            
            // Variables para almacenar la composición generada
            let currentSequence = null;
            let currentColor = null;
            let currentTalea = null;
            
            // Variable para almacenar el objeto Tone de la librería
            const Tone = window.Tone;
            let isPlaying = false;
            let playbackPart = null;
            const synth = new Tone.PolySynth(Tone.Synth).toDestination();

            // Función para mostrar mensajes de estado al usuario.
            function showMessage(msg) {
                messageBox.textContent = msg;
            }

            showMessage("Librerías cargadas. Generando primera composición...");
            
            // Definición de ritmos con sus duraciones y nombres en español.
            const rhythms = {
                '2n': { name: 'Blanca', svg: `<svg class="w-8 h-8" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><ellipse cx="50" cy="80" rx="20" ry="15" fill="none" stroke="#2563eb" stroke-width="5"/><rect x="65" y="20" width="8" height="60" fill="#2563eb" rx="2" ry="2"/></svg>`},
                '4n': { name: 'Negra', svg: `<svg class="w-8 h-8" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><ellipse cx="50" cy="80" rx="20" ry="15" fill="#2563eb"/><rect x="70" y="20" width="8" height="60" fill="#2563eb" rx="2" ry="2"/></svg>`},
                '8n': { name: 'Corchea', svg: `<svg class="w-8 h-8" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><ellipse cx="50" cy="80" rx="20" ry="15" fill="#2563eb"/><rect x="70" y="20" width="8" height="60" fill="#2563eb" rx="2" ry="2"/><path d="M 78 30 C 90 30 90 40 85 50" fill="none" stroke="#2563eb" stroke-width="8" stroke-linecap="round"/></svg>`}
            };
            
            // Ritmos disponibles para generar la Talea (solo los solicitados).
            const taleaRhythms = ['2n', '4n', '8n'];

            // Las 13 notas de la escala cromática
            const notes = ['C4', 'C#4', 'D4', 'D#4', 'E4', 'F4', 'F#4', 'G4', 'G#4', 'A4', 'A#4', 'B4', 'C5'];

            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            function generateIsorhythmia() {
                if (isPlaying) {
                    stopPlayback();
                }

                const colorLength = parseInt(colorLengthInput.value);
                const taleaLength = parseInt(taleaLengthInput.value);
                const repetitionCount = parseInt(repetitionCountInput.value);
                
                // Asegurar que la longitud de color no exceda el número de notas disponibles
                if (colorLength > notes.length) {
                    showMessage('Error: La longitud de Color no puede ser mayor que el número de notas disponibles (13).');
                    return;
                }

                // Generar el patrón de Color sin repeticiones
                const availableNotes = [...notes]; // Crear una copia de las notas disponibles
                currentColor = [];
                for (let i = 0; i < colorLength; i++) {
                    const randomIndex = getRandomInt(0, availableNotes.length - 1);
                    const selectedNote = availableNotes.splice(randomIndex, 1)[0]; // Eliminar la nota de las opciones
                    currentColor.push(selectedNote);
                }
                
                // Generar la Talea con la restricción: el primer y último ritmo no pueden ser iguales.
                if (taleaLength === 1) {
                    currentTalea = [taleaRhythms[getRandomInt(0, taleaRhythms.length - 1)]];
                } else {
                    const firstRhythm = taleaRhythms[getRandomInt(0, taleaRhythms.length - 1)];
                    const middleRhythms = [];
                    for (let i = 0; i < taleaLength - 2; i++) {
                        middleRhythms.push(taleaRhythms[getRandomInt(0, taleaRhythms.length - 1)]);
                    }
                    let lastRhythm;
                    do {
                        lastRhythm = taleaRhythms[getRandomInt(0, taleaRhythms.length - 1)];
                    } while (lastRhythm === firstRhythm);
                    currentTalea = [firstRhythm, ...middleRhythms, lastRhythm];
                }
                
                const baseSequence = [];
                let taleaIndex = 0;
                for (let i = 0; i < currentColor.length; i++) {
                    baseSequence.push({
                        note: currentColor[i],
                        duration: currentTalea[taleaIndex]
                    });
                    taleaIndex = (taleaIndex + 1) % currentTalea.length;
                }
                
                currentSequence = [];
                for (let i = 0; i < repetitionCount; i++) {
                    currentSequence.push(...baseSequence);
                }

                updateUI(currentColor, currentTalea, currentSequence);
                playButton.disabled = false;
                showMessage('Nueva composición generada. ¡Haz clic en "Reproducir" para escucharla!');
            }

            function updateUI(color, talea, combinedSequence) {
                colorDisplay.innerHTML = '';
                color.forEach(note => {
                    const noteElement = document.createElement('div');
                    noteElement.textContent = note;
                    noteElement.className = 'note-card bg-red-100 text-red-800 text-sm font-bold py-2 px-3 rounded-xl border border-red-300';
                    colorDisplay.appendChild(noteElement);
                });

                taleaDisplay.innerHTML = '';
                talea.forEach((rhythmKey, index) => {
                    const rhythm = rhythms[rhythmKey];
                    const noteElement = document.createElement('div');
                    noteElement.innerHTML = `<span class="text-sm font-bold">${rhythm.name}</span>${rhythm.svg}`;
                    noteElement.className = `note-card bg-blue-100 p-2 rounded-xl border border-blue-300 flex flex-col items-center justify-center`;
                    noteElement.dataset.index = index;
                    taleaDisplay.appendChild(noteElement);
                });

                sequenceDisplay.innerHTML = '';
                combinedSequence.forEach((item, index) => {
                    const noteCard = document.createElement('div');
                    noteCard.className = `note-card bg-purple-100 p-2 rounded-xl border border-purple-300 flex flex-col items-center justify-center`;
                    noteCard.dataset.index = index;
                    noteCard.innerHTML = `
                        <span class="text-xs font-semibold text-gray-700">${item.note}</span>
                        ${rhythms[item.duration].svg}
                    `;
                    sequenceDisplay.appendChild(noteCard);
                });
            }
            
            async function startPlayback() {
                if (currentSequence === null || isPlaying) return;
                try {
                    await Tone.start();
                } catch (e) {
                    console.error("Error al iniciar Tone.js:", e);
                    showMessage("Error: No se pudo iniciar el audio. Asegúrate de interactuar con la página primero.");
                    return;
                }
                
                isPlaying = true;
                playButton.textContent = 'Detener';
                showMessage('Reproduciendo...');
                
                if (playbackPart) {
                    playbackPart.dispose();
                }
                
                const playbackEvents = [];
                let currentTime = 0;
                const colorLength = parseInt(colorLengthInput.value);
                const taleaLength = parseInt(taleaLengthInput.value);

                currentSequence.forEach((item, index) => {
                    playbackEvents.push({
                        time: currentTime,
                        note: item.note,
                        duration: item.duration,
                        sequenceIndex: index,
                        colorIndex: index % colorLength,
                        taleaIndex: index % taleaLength
                    });
                    currentTime += Tone.Time(item.duration).toSeconds();
                });

                playbackPart = new Tone.Part((time, value) => {
                    synth.triggerAttackRelease(value.note, value.duration, time);
                    highlightNote(value.sequenceIndex, value.colorIndex, value.taleaIndex);
                }, playbackEvents).start(0);

                Tone.Transport.start();
                // Se añade un pequeño retardo para evitar un error de temporización con Tone.js
                // que puede ocurrir al final de la secuencia debido a la precisión de los números flotantes.
                Tone.Transport.scheduleOnce(() => {
                    stopPlayback();
                }, currentTime + 0.01);
            }
            
            function stopPlayback() {
                if (!isPlaying) return;
                
                Tone.Transport.stop();
                if (playbackPart) {
                    playbackPart.stop().dispose();
                    playbackPart = null;
                }
                isPlaying = false;
                playButton.textContent = 'Reproducir';
                unhighlightNotes();
                showMessage('Reproducción detenida.');
            }

            function highlightNote(sequenceIndex, colorIndex, taleaIndex) {
                unhighlightNotes();
                
                const colorElements = colorDisplay.children;
                const taleaElements = taleaDisplay.children;
                const sequenceElements = sequenceDisplay.children;

                if (sequenceElements[sequenceIndex]) {
                    sequenceElements[sequenceIndex].classList.add('active');
                }
                if (colorElements[colorIndex]) {
                    colorElements[colorIndex].classList.add('active');
                }
                if (taleaElements[taleaIndex]) {
                    taleaElements[taleaIndex].classList.add('active');
                }
            }

            function unhighlightNotes() {
                document.querySelectorAll('.note-card.active').forEach(el => {
                    el.classList.remove('active');
                });
            }

            generateButton.addEventListener('click', generateIsorhythmia);
            playButton.addEventListener('click', () => {
                if (isPlaying) {
                    stopPlayback();
                } else {
                    startPlayback();
                }
            });
            
            generateIsorhythmia();
        }
        
        // Inicializa la aplicación cuando la ventana y todos sus recursos han cargado.
        window.onload = initApp;
    </script>
</body>
</html>
